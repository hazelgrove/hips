\documentclass[index.tex]{subfiles}

\begin{document}
\newcommand{\SortNComplete}{\ensuremath{\textsf{Completeness}}}
\newcommand{\SortNCompleteVar}{\ensuremath{k}}
\newcommand{\SortComplete}{\ensuremath{\textsf{}}}
\newcommand{\SortCompleteVar}{\ensuremath{\overline{k}}}
\newcommand{\SortTypCon}{\ensuremath{\textsf{Type}}}
\newcommand{\SortTypConVar}{\ensuremath{\tau}}
\newcommand{\SortTyp}{\ensuremath{\textsf{}}}
\newcommand{\SortTypVar}{\ensuremath{\overline{\tau}}}
\newcommand{\SortComp}{\ensuremath{\textsf{Composite}}}
\newcommand{\SortCompVar}{\ensuremath{c}}
\newcommand{\SortImm}{\ensuremath{\textsf{Immediate}}}
\newcommand{\SortImmVar}{\ensuremath{i}}
\newcommand{\SortHoleIdVar}{\ensuremath{u}}
\newcommand{\SortHoleEnvVar}{\ensuremath{\SyHoleEnv}}

\newcommand{\CNC}{\ensuremath{\pie{0.3ex}{360}}}
\newcommand{\CNI}{\ensuremath{\pie{0.3ex}{0}}}
\newcommand{\CII}{\ensuremath{\pie{0.3ex}{180}}}

\newcommand{\TCHole}{\ensuremath{\SyEHole{}{}}}
\newcommand{\TCInt}{\ensuremath{\SyTInt}}
\newcommand{\TCFloat}{\ensuremath{\SyTFloat}}
\newcommand{\TCBool}{\ensuremath{\SyTBool}}
\newcommand{\TCPair}[2]{\ensuremath{#1 \SyProd #2}}

\newcommand{\TIntNC}{\ensuremath{\TMk{\TCInt}{\CNC}}}
\newcommand{\TIntNI}{\ensuremath{\TMk{\TCInt}{\CNI}}}
\newcommand{\TFloatNC}{\ensuremath{\TMk{\TCFloat}{\CNC}}}
\newcommand{\TFloatNI}{\ensuremath{\TMk{\TCFloat}{\CNI}}}
\newcommand{\TBoolNC}{\ensuremath{\TMk{\TCBool}{\CNC}}}
\newcommand{\TBoolNI}{\ensuremath{\TMk{\TCBool}{\CNI}}}
\newcommand{\TPairNC}{\ensuremath{\TMk{\TCPair}{\CNC}}}
\newcommand{\TPairNI}{\ensuremath{\TMk{\TCPair}{\CNI}}}

\newcommand{\TMk}[2]{\ensuremath{#1[#2]}}

\newcommand{\EIntLit}{\ensuremath{\underline{n}}}
\newcommand{\EFloatLit}{\ensuremath{\underline{f}}}
\newcommand{\EBoolLit}{\ensuremath{\underline{b}}}
\newcommand{\ELet}[2]{\ensuremath{\SyLet~ #1 = #2}}
\newcommand{\EIn}{\ensuremath{~\SyInn~}}
\newcommand{\EInn}[1]{\ensuremath{~\SyIn~ #1}}
\newcommand{\EReturn}[1]{\ensuremath{\SyReturn~ #1}}
\newcommand{\ECaseCompleteWith}[1]{\ensuremath{\SyCaseComplete~ #1 ~\SyWith}}
\newcommand{\ECaseCompleteBranch}[2]{\ensuremath{\SyBar~ #1 \SyArrow #2}}

\newcommand{\EWrapIntoNI}[1]{\ensuremath{\SyWrap^{\CNI}~ #1}}
\newcommand{\EWrapIntoII}[1]{\ensuremath{\SyWrap^{\CII}~ #1}}
\newcommand{\EEmbed}[1]{\ensuremath{\SyEmbed~ #1}}
\newcommand{\EProj}[2]{\ensuremath{\SyProj[#2]~ #1}}

\newcommand{\EPlus}[2]{\ensuremath{#1 \SyPlus #2}}
\newcommand{\ETimes}[2]{\ensuremath{#1 \SyTimes #2}}
\newcommand{\EFPlus}[2]{\ensuremath{#1 \SyFPlus #2}}
\newcommand{\EFTimes}[2]{\ensuremath{#1 \SyFTimes #2}}

\newcommand{\ETrue}{\ensuremath{\SyTrue}}
\newcommand{\EAnd}[2]{\ensuremath{#1 \SyAnd #2}}
\newcommand{\EOr}[2]{\ensuremath{#1 \SyOr #2}}

\newcommand{\EPair}[2]{\ensuremath{(#1, #2)}}
\newcommand{\EProjL}[1]{\ensuremath{\SyProjL~ #1}}
\newcommand{\EProjR}[1]{\ensuremath{\SyProjR~ #1}}

\newcommand{\EEHole}[2]{\ensuremath{\SyEHole{#1}{#2}}}

\newcommand{\EVarNamed}[2]{\ensuremath{t_{#1}^{{\color{gray}#2}}}}

\subsubsection{Lower intermediate representation (LIR)}
\label{sec:lir}

In the lower intermediate representation (LIR), whose syntax is partially given in
\cref{fig:lir-syntax}, completeness (see below) is made explicit in the type system
(see \Cref{fig:lir-ta-imm,fig:lir-ta-comp}).

\begin{figure}
  \[\begin{array}{rccl}
    \SortNComplete & \SortNCompleteVar & \Coloneqq & \CNC \mid \CNI \\
    \SortComplete  & \SortCompleteVar  & \Coloneqq & \SortNCompleteVar \mid \CII \\
    \SortTypCon    & \SortTypConVar    & \Coloneqq & \TCHole \mid \TCInt \mid \TCFloat \mid \TCBool 
                                                   \mid \TCPair{\SortTypConVar}{\SortTypConVar} \\
    \SortTyp       & \SortTypVar       & \Coloneqq & \TMk{\SortTypConVar}{\SortCompleteVar} \\
    \SortImm       & \SortImmVar       & \Coloneqq & x \mid \EEHole{\SortHoleIdVar}{\SortHoleEnvVar}
                                                   \mid \EIntLit \mid \EFloatLit \mid \EBoolLit \\
    \SortComp      & \SortCompVar      & \Coloneqq & \SortImmVar \\
                   &                   & \mid         & \EPlus{\SortImmVar}{\SortImmVar} 
                                                   \mid \ETimes{\SortImmVar}{\SortImmVar}
                                                   \mid \EFPlus{\SortImmVar}{\SortImmVar} 
                                                   \mid \EFTimes{\SortImmVar}{\SortImmVar}
                                                   \mid \EAnd{\SortImmVar}{\SortImmVar}
                                                   \mid \EOr{\SortImmVar}{\SortImmVar} \\
                   &                   & \mid         & \EPair{\SortImmVar}{\SortImmVar}
                                                   \mid \EProjL{\SortImmVar}
                                                   \mid \EProjR{\SortImmVar} \\
                   &                   & \mid         & \EWrapIntoNI{\SortImmVar}
                                                   \mid \EWrapIntoII{\SortImmVar} \\
                   &                   & \mid         & \EEmbed{\SortImmVar}
                                                   \mid \EProj{\SortImmVar}{\SortTypConVar} \\
                   &                   & \mid         & \ELet{x}{\SortCompVar} \EInn{\SortCompVar} \\
                   &                   & \mid         & \ECaseCompleteWith{\SortImmVar}
                                                    ~\ECaseCompleteBranch{x}{\SortCompVar}
                                                    ~\ECaseCompleteBranch{x'}{\SortCompVar}
  \end{array}\]
  %
  \caption{LIR syntax}
  \label{fig:lir-syntax}
\end{figure}

\paragraph{Completeness}
Completeness (see \Cref{completeness}) is denoted by $\SortCompleteVar$, with "necessarily" cases given
by $\SortNCompleteVar$: $\CNC =$ necessary completeness, $\CNI =$ necessary incompleteness, and
$\CII =$ indeterminate incompleteness. They are encoded in types, which are given by the
metavariable $\SortTypVar$. A type $\TMk{\SortTypConVar}{\SortCompleteVar}$ is thus a ``concrete''
type $\SortTypConVar$ (need a better name for this) parameterized by completeness
$\SortCompleteVar$.

\paragraph{Immediates}
Similar to the high intermediate representation, a distinction is made between \emph{immediates}
(given by $\SortImmVar$) and \emph{composites} (computations, given by $\SortCompVar$). Immediates
are either literals or variables.

\begin{figure}
  \judgbox{\hasTypeCtx{\CtxVar}{\HoleCtxVar}{\SortImmVar}{\SortTypVar}}
  %
  \begin{mathpar}
    \judgment{
      \holeHasTypeCtx{\HoleCtxVar}{\SortHoleIdVar}{\SortTypConVar}{\CtxVar'} \\
      \hasTypeCtx{\CtxVar}{\HoleCtxVar}{\sigma}{\CtxVar'}
    }{
      \hasTypeCtx{\CtxVar}{\HoleCtxVar}{\EEHole{\SortHoleIdVar}{\sigma}}{\TMk{\SortTypConVar}{\CNI}}
    }{TAEHole} \and

    \judgment{
      \hasType{x}{\SortTypVar} \in \CtxVar
    }{
      \hasTypeCtx{\CtxVar}{\HoleCtxVar}{x}{\SortTypVar}
    }{TAVar} \\

    \judgment{ }{
      \hasTypeCtx{\CtxVar}{\HoleCtxVar}{\EIntLit}{\TIntNC}
    }{TAIntLit} \and

    \judgment{ }{
      \hasTypeCtx{\CtxVar}{\HoleCtxVar}{\EIntLit}{\TFloatNC}
    }{TAFloatLit} \and

    \judgment{ }{
      \hasTypeCtx{\CtxVar}{\HoleCtxVar}{\EBoolLit}{\TBoolNC}
    }{TABoolLit}
  \end{mathpar}
  %
  \caption{Type assignment for LIR immediates}
  \label{fig:lir-ta-imm}
\end{figure}

\Cref{fig:lir-ta-imm} gives the type assignment rules for immediates, which are quite
straightforward. The rule for holes $\EEHole{\SortHoleIdVar}{\SortHoleEnvVar}$ is the same as
that of the internal \Hazel{} language.

\paragraph{Composites}
See \cref{fig:lir-syntax-comp} for an brief overview of the composite forms. Note the operations that
are polymorphic over necessary completeness (e.g. integer addition).

\begin{table}
  \begin{center}
    \begin{tabular}{rl}
      \textbf{Form} & \textbf{Description} \\

      $\SortImmVar$ 
        & immediates are also composites \\
      
      $\EPlus{\SortImmVar}{\SortImmVar}$, $\ETimes{\SortImmVar}{\SortImmVar}$
        & addition, multiplication of two $\TCInt$ immediates \\

      $\EFPlus{\SortImmVar}{\SortImmVar}$, $\EFTimes{\SortImmVar}{\SortImmVar}$
        & addition, multiplication of two $\TCFloat$ immediates \\

      $\EAnd{\SortImmVar}{\SortImmVar}$, $\EOr{\SortImmVar}{\SortImmVar}$
        & logical and, logical or of two $\TCBool$ immediates \\

      $\EPair{\SortImmVar}{\SortImmVar}$
        & pair construction \\

      $\EProjL{\SortImmVar}$, $\EProjR{\SortImmVar}$
        & left and right pair projection \\

      $\EWrapIntoNI{\SortImmVar}$
        & wrapping of a value into an indet. result \\

      $\EWrapIntoII{\SortImmVar}$
        & wrapping of an immediate into a indeterminately incomplete
        result \\

      $\EEmbed{\SortImmVar}$
        & embedding of an immediate into a cast proxy \\

      $\EProj{\SortTypConVar}{\SortImmVar}$
        & projection of a proxy to a target type $\SortTypConVar$; dynamic type check and may fail \\

      $\ELet{x}{\SortCompVar} \EIn \SortCompVar$
        & variable binding \\

      $\ECaseCompleteWith{\SortImmVar} ~\cdots$
        & dynamic check; first branch taken if value, second branch if indet. result
    \end{tabular}
  \end{center}
  %
  \caption{Overview of LIR composite forms}
  \label{fig:lir-syntax-comp}
\end{table}

The syntax and type assignment rules (see \Cref{fig:lir-ta-comp}) enforce serious computations to be
on either necessarily complete or necessarily incomplete immediates; indeterminately incomplete
results may be introduced only either by wrapping (\textsc{\small TAWrapIntoII}) or by projecting a
cast proxy (\textsc{\small TAProj}), and eliminated only by $\SyCaseComplete$ (\textsc{\small
TACaseComplete}).

\begin{figure}
  \judgbox{\hasTypeCtx{\CtxVar}{\HoleCtxVar}{\SortCompVar}{\SortTypVar}} \\

  Integers:
  \begin{mathpar}
    \judgment{
      \hasTypeCtx{\CtxVar}{\HoleCtxVar}{\SortImmVar}{\TMk{\TCInt}{\SortNCompleteVar}} \\
      \hasTypeCtx{\CtxVar}{\HoleCtxVar}{\SortImmVar'}{\TMk{\TCInt}{\SortNCompleteVar}}
    }{
      \hasTypeCtx{\CtxVar}{\HoleCtxVar}{\EPlus{\SortImmVar}{\SortImmVar'}}{\TMk{\TCInt}{\SortNCompleteVar}}
    }{TAPlus} \and

    \judgment{
      \hasTypeCtx{\CtxVar}{\HoleCtxVar}{\SortImmVar}{\TMk{\TCInt}{\SortNCompleteVar}} \\
      \hasTypeCtx{\CtxVar}{\HoleCtxVar}{\SortImmVar'}{\TMk{\TCInt}{\SortNCompleteVar}}
    }{
      \hasTypeCtx{\CtxVar}{\HoleCtxVar}{\ETimes{\SortImmVar}{\SortImmVar'}}{\TMk{\TCInt}{\SortNCompleteVar}}
    }{TATimes}
  \end{mathpar} \\
  %
  Floats:
  \begin{mathpar}
    \judgment{
      \hasTypeCtx{\CtxVar}{\HoleCtxVar}{\SortImmVar}{\TMk{\TCFloat}{\SortNCompleteVar}} \\
      \hasTypeCtx{\CtxVar}{\HoleCtxVar}{\SortImmVar'}{\TMk{\TCFloat}{\SortNCompleteVar}}
    }{
      \hasTypeCtx{\CtxVar}{\HoleCtxVar}{\EFPlus{\SortImmVar}{\SortImmVar'}}{\TMk{\TCFloat}{\SortNCompleteVar}}
    }{TAFPlus} \and

    \judgment{
      \hasTypeCtx{\CtxVar}{\HoleCtxVar}{\SortImmVar}{\TMk{\TCFloat}{\SortNCompleteVar}} \\
      \hasTypeCtx{\CtxVar}{\HoleCtxVar}{\SortImmVar'}{\TMk{\TCFloat}{\SortNCompleteVar}}
    }{
      \hasTypeCtx{\CtxVar}{\HoleCtxVar}{\EFTimes{\SortImmVar}{\SortImmVar'}}{\TMk{\TCFloat}{\SortNCompleteVar}}
    }{TAFTimes}
  \end{mathpar} \\
  %
  Booleans:
  \begin{mathpar}
    \judgment{
      \hasTypeCtx{\CtxVar}{\HoleCtxVar}{\SortImmVar}{\TMk{\TCBool}{\SortNCompleteVar}} \\
      \hasTypeCtx{\CtxVar}{\HoleCtxVar}{\SortImmVar'}{\TMk{\TCBool}{\SortNCompleteVar}}
    }{
      \hasTypeCtx{\CtxVar}{\HoleCtxVar}{\EAnd{\SortImmVar}{\SortImmVar'}}{\TMk{\TCBool}{\SortNCompleteVar}}
    }{TAAnd} \and

    \judgment{
      \hasTypeCtx{\CtxVar}{\HoleCtxVar}{\SortImmVar}{\TMk{\TCBool}{\SortNCompleteVar}} \\
      \hasTypeCtx{\CtxVar}{\HoleCtxVar}{\SortImmVar'}{\TMk{\TCBool}{\SortNCompleteVar}}
    }{
      \hasTypeCtx{\CtxVar}{\HoleCtxVar}{\EOr{\SortImmVar}{\SortImmVar'}}{\TMk{\TCBool}{\SortNCompleteVar}}
    }{TAOr}
  \end{mathpar} \\
  %
  Pairs:
  \begin{mathpar}
    \judgment{
      \hasTypeCtx{\CtxVar}{\HoleCtxVar}{\SortImmVar}{\TMk{\SortTypConVar}{\SortNCompleteVar}} \\
      \hasTypeCtx{\CtxVar}{\HoleCtxVar}{\SortImmVar'}{\TMk{\SortTypConVar'}{\SortNCompleteVar}}
    }{
      \hasTypeCtx{\CtxVar}{\HoleCtxVar}{\EPair{\SortImmVar}{\SortImmVar'}}{\TMk{\TCPair{\SortTypConVar}{\SortTypConVar'}}{\SortNCompleteVar}}
    }{TAPair} \\

    \judgment{
      \hasTypeCtx{\CtxVar}{\HoleCtxVar}{\SortImmVar}{\TMk{\TCPair{\SortTypConVar}{\SortTypConVar'}}{\SortNCompleteVar}}
    }{
      \hasTypeCtx{\CtxVar}{\HoleCtxVar}{\EProjL{\SortImmVar}}{\TMk{\SortTypConVar}{\SortNCompleteVar}} \\
    }{TAFst} \and

    \judgment{
      \hasTypeCtx{\CtxVar}{\HoleCtxVar}{\SortImmVar}{\TMk{\TCPair{\SortTypConVar}{\SortTypConVar'}}{\SortNCompleteVar}}
    }{
      \hasTypeCtx{\CtxVar}{\HoleCtxVar}{\EProjR{\SortImmVar}}{\TMk{\SortTypConVar'}{\SortNCompleteVar}} \\
    }{TASnd}
  \end{mathpar} \\
  %
  Wrapping:
  \begin{mathpar}
    \judgment{
      \hasTypeCtx{\CtxVar}{\HoleCtxVar}{\SortImmVar}{\TMk{\SortTypConVar}{\CNC}}
    }{
      \hasTypeCtx{\CtxVar}{\HoleCtxVar}{\EWrapIntoNI{\SortImmVar}}{\TMk{\SortTypConVar}{\CNI}}
    }{TAWrapIntoNI} \and

    \judgment{
      \hasTypeCtx{\CtxVar}{\HoleCtxVar}{\SortImmVar}{\TMk{\SortTypConVar}{\SortNCompleteVar}}
    }{
      \hasTypeCtx{\CtxVar}{\HoleCtxVar}{\EWrapIntoII{\SortImmVar}}{\TMk{\SortTypConVar}{\CII}}
    }{TAWrapIntoII}
  \end{mathpar} \\
  %
  Casting:
  \begin{mathpar}
    \judgment{
      \hasTypeCtx{\CtxVar}{\HoleCtxVar}{\SortImmVar}{\TMk{\SortTypConVar}{\SortNCompleteVar}}
    }{
      \hasTypeCtx{\CtxVar}{\HoleCtxVar}{\EEmbed{\SortImmVar}}{\TMk{\TCHole}{\CNI}}
    }{TAEmbed} \and

    \judgment{
      \hasTypeCtx{\CtxVar}{\HoleCtxVar}{\SortImmVar}{\TMk{\SortTypConVar}{\CNI}}
    }{
      \hasTypeCtx{\CtxVar}{\HoleCtxVar}{\EProj{\SortImmVar}{\SortTypConVar'}}{\TMk{\SortTypConVar'}{\CII}}
    }{TAProj}
  \end{mathpar} \\
  %
  Binding:
  \begin{mathpar}
    \judgment{
      \hasTypeCtx{\CtxVar}{\HoleCtxVar}{\SortCompVar}{\SortTypVar} \\
      \hasTypeCtx{\extendCtx{\CtxVar}{x}{\SortTypVar}}{\HoleCtxVar}{\SortCompVar'}{\SortTypVar'}
    }{
      \hasTypeCtx{\CtxVar}{\HoleCtxVar}{\ELet{x}{\SortCompVar} \EIn \SortCompVar'}{\SortTypVar'}
    }{TALet}
  \end{mathpar} \\
  %
  $\CII$ elimination:
  \begin{mathpar}
    \judgment{
      \hasTypeCtx{\CtxVar}{\HoleCtxVar}{\SortImmVar}{\TMk{\SortTypConVar}{\CII}} \\\\
      \hasTypeCtx{\extendCtx{\CtxVar}{x}{\TMk{\SortTypConVar}{\CNC}}}{\HoleCtxVar}{\SortCompVar}{\SortTypVar} \\
      \hasTypeCtx{\extendCtx{\CtxVar}{x'}{\TMk{\SortTypConVar}{\CNI}}}{\HoleCtxVar}{\SortCompVar'}{\SortTypVar}
    }{
      \hasTypeCtx{\CtxVar}{\HoleCtxVar}{
        \ECaseCompleteWith{\SortImmVar}
          \ECaseCompleteBranch{x}{\SortCompVar}
          ~\ECaseCompleteBranch{x'}{\SortCompVar'}
        }{\SortTypVar}
    }{TACaseComplete}
  \end{mathpar}
  %
  \caption{Type assignment for LIR composites}
  \label{fig:lir-ta-comp}
\end{figure}

\subsubsection{Explicitization}
\label{sec:explicitization}

\begin{figure}
  \caption{LIR function-local completeness analysis}
  \label{fig:lir-completeness-analysis-local}
\end{figure}
   
\end{document}
